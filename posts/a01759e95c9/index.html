<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Blender 2.82 Render Engine" /><meta name="author" content="帽捲" /><meta property="og:locale" content="en" /><meta name="description" content="簡介如何創建自己的render engine" /><meta property="og:description" content="簡介如何創建自己的render engine" /><link rel="canonical" href="https://medium-to-jekyll-starter.zhgchg.li//posts/a01759e95c9/" /><meta property="og:url" content="https://medium-to-jekyll-starter.zhgchg.li//posts/a01759e95c9/" /><meta property="og:site_name" content="Medium To Jekyll Starter" /><meta property="og:image" content="https://medium-to-jekyll-starter.zhgchg.li//assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-23T23:51:50+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://medium-to-jekyll-starter.zhgchg.li//assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png" /><meta property="twitter:title" content="Blender 2.82 Render Engine" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@帽捲" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"帽捲"},"dateModified":"2020-11-24T13:36:58+08:00","datePublished":"2020-03-23T23:51:50+08:00","description":"簡介如何創建自己的render engine","headline":"Blender 2.82 Render Engine","image":"https://medium-to-jekyll-starter.zhgchg.li//assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://medium-to-jekyll-starter.zhgchg.li//posts/a01759e95c9/"},"url":"https://medium-to-jekyll-starter.zhgchg.li//posts/a01759e95c9/"}</script><title>Blender 2.82 Render Engine | Medium To Jekyll Starter</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Medium To Jekyll Starter"><meta name="application-name" content="Medium To Jekyll Starter"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Medium To Jekyll Starter</a><p class="site-subtitle fst-italic mb-0">A text-focused Jekyll theme</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Blender 2.82 Render Engine</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Blender 2.82 Render Engine</h1><p class="post-desc fw-light mb-4">簡介如何創建自己的render engine</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1584978710" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 23, 2020 </time> </span> <span> Updated <time data-ts="1606196218" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 24, 2020 </time> </span><div class="mt-3 mb-3"> <a href="/assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png" class="popup img-link preview-img shimmer"><img src="/assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2317 words" > <em>12 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Blender 2.82 Render Engine</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Blender 2.82 Render Engine</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h3 id="blender-282-render-engine"><span class="me-2">Blender 2.82 Render Engine</span><a href="#blender-282-render-engine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>blender2.8 原則上把整個engine的結構都整理出來，尤其是在2.82板後又重新整理過，這邊就來介紹一下。</p><p>首先，最簡單的應用就是我要怎麼加自己的render engine，</p><p><a href="/assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*Iv-hWkYbL74XpwH4.png" alt="" loading="lazy"></a></p><p>如果只是原始的blender，Render engine應該只會有Eevee, Workbench, Cycles，而這些engine都是透過2種方式來註冊</p><blockquote><p>Python</p></blockquote><blockquote><p>C</p></blockquote><h3 id="python"><span class="me-2">Python</span><a href="#python" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>首先是Python端，你可以在blender.exe的那個資料夾看到類似”2.82”之類的資料夾，這因為版本會有不一樣，在 <em>2.82\scripts\addons\cycles\ _ _init_ _ .py</em> 裡面有這麼幾行</p><blockquote><p>classes = (</p></blockquote><blockquote><p>CyclesRender,</p></blockquote><blockquote><p>)</p></blockquote><blockquote><p>…</p></blockquote><blockquote><p>for cls in classes:</p></blockquote><blockquote><p>register_class(cls)</p></blockquote><p>這邊就是把CyclesRender進行註冊，也就是說你看的Cycles就是從Python端在runtime的時候註冊的(這邊猜測是因為要提供使用者方便用OSL，所以必須用python作為接口)</p><p>那其他的程式碼就先不管她，我們可以看到官網有提供 <a href="https://docs.blender.org/api/master/bpy.types.RenderEngine.html#bpy.types.RenderEngine.active_view_set" target="_blank">簡單例子</a> ，你可以把整段程式碼複製下來做成一個addon就可以了，記得要去pefermance&gt;addon把這個addon打開，可以看到它也有類似的註冊</p><blockquote><p>bpy.utils.register_class(CustomRenderEngine)</p></blockquote><p>我這邊把它的名子改成了Custom_Python，所以你可以看到上面我的Rrender Engine裡面有這個東西。</p><p>但是依據這個簡單的例子，我們可以稍微理解如果要自己寫Render Engine要怎麼做，以這個例子來說，如果對於血Blender有點研究就會發現他只是利用bgl[1]去render，但是如果是Cycles，它就複雜很多，它透過C code編譯許多tool給Cycles使用，也就是它不是純粹用Python來實作。</p><h3 id="c"><span class="me-2">C</span><a href="#c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>其實分成這兩種事不太準確的，因為其實都是C端進行註冊的，但不妨我們先這種認為，先聲明，後面的東西涉及底層的C code，所以如果只有下載軟體，沒有把整個專案載下來重編過的是看不到後面的東西，然後這邊我用的是Blender 2.82，你可以在原始的檔案中找到這個資料夾</p><p><em>blender\source\blender\draw\engines</em></p><p>裡面就有好幾個engine，包含eevee, workbench和external，那為什麼我們預設只有eevee跟workbench呢?</p><p>在 <em>blender\source\blender\draw\intern\draw_manager.c，</em> 裡面有</p><blockquote><p>void DRW_engines_register(void)</p></blockquote><blockquote><p>{</p></blockquote><blockquote><p>RE_engines_register(&amp;DRW_engine_viewport_eevee_type);</p></blockquote><blockquote><p>RE_engines_register(&amp;DRW_engine_viewport_workbench_type);</p></blockquote><blockquote><p>…</p></blockquote><blockquote><p>}</p></blockquote><p>這個就是註冊的地方了，可以看到只有註冊這兩種Render engine，那這邊我們會好奇說，那剛剛有提到的external呢?</p><p>只要加這一行在下面</p><blockquote><p>RE_engines_register(&amp;DRW_engine_viewport_external_type);</p></blockquote><p>那你就會多這個engine啦，但我猜測這個engine應該是個樣板給別人看的，因為你實際打開來會發現只有做depth pass，但是透過這個樣板，我們可以知道如何在C code增加Render engine，在最後我會說明一下怎麼寫一個簡單的engine。</p><p>那你可能會好奇，那Cycles有什麼不一樣呢，其實本質上是一樣的，怎麼說呢?以eevee的例子來說，它在blender還沒有開始把視窗建出來，還沒執行任何python腳本之前，就會執行上面看到的</p><blockquote><p>DRW_engines_register( )</p></blockquote><p>也就是註冊一些預設內建的Render Engine。</p><p>那如果是利用Python來註冊，則是利用</p><blockquote><p>bpy.utils.register_class</p></blockquote><p>這個東西其實是會去call 底層的C code的，它其會去呼叫</p><blockquote><p>rna_RenderEngine_register( )</p></blockquote><p>這個function，然後再進一步就會呼叫</p><blockquote><p>RE_engines_register( )</p></blockquote><p>這個就跟前面DRW_engines_register( )裡面的註冊是一樣的，也就是說無論是哪種註冊，最終都要透過</p><blockquote><p>DRW_engines_register</p></blockquote><p>來註冊Render Engine，如果畫成圖類似這樣</p><p><a href="/assets/a01759e95c9/0*08Ds5NaQ1RznasO8.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*08Ds5NaQ1RznasO8.png" alt="" loading="lazy"></a></p><p>那麼最後，我們要怎麼做一個簡單的Render Engine呢?</p><h3 id="custom-engine"><span class="me-2">Custom Engine</span><a href="#custom-engine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>首先，要做一個engine總要有個目標，我這邊的目標是可以讓wireframe產生random色彩的engine，奇怪，這個功能不是本來就有了嗎?</p><p><a href="/assets/a01759e95c9/0*scmt4jZAse4lHCRe.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*scmt4jZAse4lHCRe.png" alt="" loading="lazy"></a></p><p>沒錯，就如同上面一樣，但是，不幸的是你會發現Curve卻沒有這個功能，也就是只有mesh之類的東西才有隨機的顏色。</p><p>所以我們要來把它做出來，但在做之前，可能要搞清楚Blender的Render Pipeline是怎麼跑的， <a href="https://wiki.blender.jp/Dev:2.8/Source/Viewport/DrawManager" target="_blank">這篇</a> 有蠻清楚的描述，首先，每個Render engine下面要定義一個Draw Engine，而Draw Engine則是實際上render時拿來渲染的資料，所以可以看到 <em>blender\source\blender\draw\engines\eevee，</em> 裡面的 <em>eevee_engine.c</em> 有如下定義，</p><blockquote><p>DrawEngineType draw_engine_eevee_type = {</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>N_ (“Eevee”),</p></blockquote><blockquote><p>&amp;eevee_data_size,</p></blockquote><blockquote><p>&amp;eevee_engine_init,</p></blockquote><blockquote><p>&amp;eevee_engine_free,</p></blockquote><blockquote><p>&amp;eevee_cache_init,</p></blockquote><blockquote><p>&amp;EEVEE_cache_populate,</p></blockquote><blockquote><p>&amp;eevee_cache_finish,</p></blockquote><blockquote><p>&amp;eevee_draw_background,</p></blockquote><blockquote><p>NULL, /* Everything is drawn in the background pass (see comment on function) */</p></blockquote><blockquote><p>&amp;eevee_view_update,</p></blockquote><blockquote><p>&amp;eevee_id_update,</p></blockquote><blockquote><p>&amp;eevee_render_to_image,</p></blockquote><blockquote><p>};</p></blockquote><blockquote><p>RenderEngineType DRW_engine_viewport_eevee_type = {</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>EEVEE_ENGINE,</p></blockquote><blockquote><p>N_ (“Eevee”),</p></blockquote><blockquote><p>RE_INTERNAL | RE_USE_PREVIEW,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>&amp;DRW_render_to_image,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>&amp;EEVEE_render_update_passes,</p></blockquote><blockquote><p>&amp;draw_engine_eevee_type,</p></blockquote><blockquote><p>{NULL, NULL, NULL},</p></blockquote><blockquote><p>};</p></blockquote><p>分別定義了Render Engine跟Draw Engine，也可以發現Render Engine裡面有 <em>Draw Engine draw_engine_eevee_type，</em> 而前面提到的註冊也就是用這邊的Render Engine， <em>DRW_engine_viewport_eevee_type</em></p><p>那把焦點放在Draw Engine，因為它才是實際上渲染的，我們可以用這張圖來搭配，</p><p><a href="/assets/a01759e95c9/0*HLmZqwWQqR6hC61p.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*HLmZqwWQqR6hC61p.png" alt="" loading="lazy"></a></p><p>簡單來說，每一次render的loop會重複下面的流程</p><blockquote><p>DRW_engine_init</p></blockquote><blockquote><p>DRW_engine_cache_init</p></blockquote><blockquote><p>DRW_engine_cache_populate</p></blockquote><blockquote><p>DRW_engine_cache_finish</p></blockquote><blockquote><p>DRW_draw_scene</p></blockquote><p>也就是我們會先把engine初始化，把一些資料去先宣告好，再來是把快取初始化，其實就是把shader跟pass建好，pass在blender這邊的結構是這樣的</p><p><a href="/assets/a01759e95c9/0*dg47B5eICe1Ma7H0.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*dg47B5eICe1Ma7H0.png" alt="" loading="lazy"></a></p><p>簡單來說，render時最大的單位就是pass，一個pass可以有很多 <em>shadingGroup</em> ，那一個 <em>shadingGroup</em> 裡面只有一個shader，但可以有很多個要渲染的geometry(或者說是object)，而每個geometry跟shader就會對應成一個 <em>call</em> ，那這個 <em>call</em> 就是render原則上的最小的單位。</p><p>也就是會像這樣</p><p><a href="/assets/a01759e95c9/0*PXaoeim_de5T23mr.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*PXaoeim_de5T23mr.png" alt="" loading="lazy"></a></p><p>講了這麼多，我們回來看eevee，可以看到它有這些funtion</p><blockquote><p>&amp;eevee_engine_init,</p></blockquote><blockquote><p>&amp;eevee_engine_free,</p></blockquote><blockquote><p>&amp;eevee_cache_init,</p></blockquote><blockquote><p>&amp;EEVEE_cache_populate,</p></blockquote><blockquote><p>&amp;eevee_cache_finish,</p></blockquote><blockquote><p>&amp;eevee_draw_background,</p></blockquote><p>這些function都是在整個流程上會用到的，所以我們可以參考eevee的架構來寫</p><blockquote><p>DrawEngineType draw_engine_custom_type = {</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>N_ (“Custom”),</p></blockquote><blockquote><p>&amp;custom_data_size,</p></blockquote><blockquote><p>&amp;custom_engine_init,</p></blockquote><blockquote><p>&amp;custom_engine_free,</p></blockquote><blockquote><p>&amp;custom_cache_init,</p></blockquote><blockquote><p>&amp;custom_cache_populate,</p></blockquote><blockquote><p>&amp;custom_cache_finish,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>&amp;custom_draw_scene,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>};</p></blockquote><blockquote><p>RenderEngineType DRW_engine_custom_type = {</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>CUSTOM_ENGINE,</p></blockquote><blockquote><p>N_ (“Custom”),</p></blockquote><blockquote><p>RE_INTERNAL | RE_USE_PREVIEW,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>&amp;DRW_render_to_image,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>NULL,</p></blockquote><blockquote><p>&amp;custom_render_update_passes,</p></blockquote><blockquote><p>&amp;draw_engine_custom_type,</p></blockquote><blockquote><p>{NULL, NULL, NULL},</p></blockquote><blockquote><p>};</p></blockquote><p>並且記得在DRW_engines_register裡面加上</p><blockquote><p>RE_engines_register(&amp;DRW_engine_custom_type);</p></blockquote><p>只要成功，就可以看到Render Engine那邊多了一個Custom，接下來就只要實作每個函式了，首先是</p><blockquote><p>static void custom_engine_init(void *vedata)</p></blockquote><blockquote><p>{</p></blockquote><blockquote><p>CUSTOM_Data *data = vedata;</p></blockquote><blockquote><p>CUSTOM_StorageList *stl = data-&gt;stl;</p></blockquote><blockquote><p>const DRWContextState *draw_ctx = DRW_context_state_get( );</p></blockquote><blockquote><p>const View3D *v3d = draw_ctx-&gt;v3d;</p></blockquote><blockquote><p>if ( !stl-&gt;pd)</p></blockquote><blockquote><p>stl-&gt;pd = MEM_callocN(sizeof( *stl-&gt;pd), _ _func_ _ );</p></blockquote><blockquote><p>CUSTOM_PrivateData *pd = stl-&gt;pd;</p></blockquote><blockquote><p>pd-&gt;hide_overlays = (v3d-&gt;flag2 &amp; V3D_HIDE_OVERLAYS) != 0;</p></blockquote><blockquote><p>if ( !stl-&gt;pd-&gt;hide_overlays)</p></blockquote><blockquote><p>stl-&gt;pd-&gt;overlay = v3d-&gt;overlay;</p></blockquote><blockquote><p>else</p></blockquote><blockquote><p>memset(&amp;stl-&gt;pd-&gt;overlay, 0, sizeof(stl-&gt;pd-&gt;overlay) );</p></blockquote><blockquote><p>if (v3d-&gt;shading.type == OB_WIRE)</p></blockquote><blockquote><p>stl-&gt;pd-&gt;overlay.flag |= V3D_OVERLAY_WIREFRAMES;</p></blockquote><blockquote><p>}</p></blockquote><p>這邊其實沒必要特別去處理overlay的東西，主要看得是把裡面的資料初始化</p><p>再來是</p><blockquote><p>static void custom_cache_init(void *vedata)</p></blockquote><blockquote><p>{</p></blockquote><blockquote><p>CUSTOM_Data *data = vedata;</p></blockquote><blockquote><p>CUSTOM_PassList *psl = data-&gt;psl;</p></blockquote><blockquote><p>CUSTOM_PrivateData *pd = data-&gt;stl-&gt;pd;</p></blockquote><blockquote><p>const DRWContextState *draw_ctx = DRW_context_state_get( );</p></blockquote><blockquote><p>View3DShading *shading = &amp;draw_ctx-&gt;v3d-&gt;shading;</p></blockquote><blockquote><p>pd-&gt;wire_step_param = pd-&gt;overlay.wireframe_threshold — 254.0f / 255.0f;</p></blockquote><blockquote><p>bool is_wire_shmode = (shading-&gt;type == OB_WIRE);</p></blockquote><blockquote><p>bool is_material_shmode = (shading-&gt;type &gt; OB_SOLID);</p></blockquote><blockquote><p>bool is_object_color = is_wire_shmode &amp;&amp; (shading-&gt;wire_color_type == V3D_SHADING_OBJECT_COLOR);</p></blockquote><blockquote><p>bool is_random_color = is_wire_shmode &amp;&amp; (shading-&gt;wire_color_type == V3D_SHADING_RANDOM_COLOR);</p></blockquote><blockquote><p>GPUShader *shader = CUSTOM_shader( );</p></blockquote><blockquote><p>DRWState state = DRW_STATE_WRITE_COLOR | DRW_STATE_WRITE_DEPTH | DRW_STATE_DEPTH_LESS_EQUAL |</p></blockquote><blockquote><p>DRW_STATE_STENCIL_EQUAL | DRW_STATE_FIRST_VERTEX_CONVENTION;</p></blockquote><blockquote><p>// DRW_STATE_STENCIL_EQUAL 會執行stencil test</p></blockquote><blockquote><p>DRW_PASS_CREATE(psl-&gt;custom_default_ps, state);</p></blockquote><blockquote><p>DRWPass *pass = psl-&gt;custom_default_ps;</p></blockquote><blockquote><p>DRWShadingGroup *grp = pd-&gt;shgrp = DRW_shgroup_create(shader, pass);</p></blockquote><blockquote><p>DRW_shgroup_uniform_block_persistent(grp, “globalsBlock”, G_draw.block_ubo);</p></blockquote><blockquote><p>DRW_shgroup_uniform_float_copy(grp, “wireStepParam”, pd-&gt;wire_step_param);</p></blockquote><blockquote><p>DRW_shgroup_uniform_bool_copy(grp, “useColoring”, true);</p></blockquote><blockquote><p>DRW_shgroup_uniform_bool_copy(grp, “isTransform”, (G.moving &amp; G_TRANSFORM_OBJ) != 0);</p></blockquote><blockquote><p>DRW_shgroup_uniform_bool_copy(grp, “isObjectColor”, false);</p></blockquote><blockquote><p>DRW_shgroup_uniform_bool_copy(grp, “isRandomColor”, true);</p></blockquote><blockquote><p>DRW_shgroup_stencil_mask(grp, 0xFF); // stencil buffer 可寫</p></blockquote><blockquote><p>}</p></blockquote><p>詳細的東西就不講，總之就是把shader跟pass建出來，比較特別的是Blender的shader會透過Cmake把glsl code轉成字元陣列，這樣就可以快速compile，具體可以看 <em>blender\source\blender\draw\CMakeLists.txt，</em> 裡面有一大串 <em>data_to_c_simple</em></p><p>你可以自己寫一些shader，然後要記得在這邊加對應的數量，這樣他才會把你寫的編成字元陣列，然後是</p><blockquote><p>static void custom_cache_populate(void *vedata, Object *ob)</p></blockquote><blockquote><p>{</p></blockquote><blockquote><p>CUSTOM_Data *data = vedata;</p></blockquote><blockquote><p>CUSTOM_PrivateData *pd = data-&gt;stl-&gt;pd;</p></blockquote><blockquote><p>struct GPUBatch *geom = NULL;</p></blockquote><blockquote><p>if (ob-&gt;type == OB_MESH)</p></blockquote><blockquote><p>geom = DRW_cache_mesh_face_wireframe_get(ob);</p></blockquote><blockquote><p>else if (ob-&gt;type == OB_CURVE)</p></blockquote><blockquote><p>geom = DRW_cache_curve_edge_wire_get(ob);</p></blockquote><blockquote><p>if (geom) {</p></blockquote><blockquote><p>DRW_shgroup_call(pd-&gt;shgrp, geom, ob);</p></blockquote><blockquote><p>}</p></blockquote><blockquote><p>}</p></blockquote><p>這邊就是看object的類型，如果是mesh，那就拿它的wireframe，如果是curve，那就拿線的wire，最後加call到shading group，最後是</p><blockquote><p>static void custom_draw_scene(void *vedata)</p></blockquote><blockquote><p>{</p></blockquote><blockquote><p>CUSTOM_Data* data = vedata;</p></blockquote><blockquote><p>CUSTOM_PassList *psl = data-&gt;psl;</p></blockquote><blockquote><p>CUSTOM_PrivateData *pd = data-&gt;stl-&gt;pd;</p></blockquote><blockquote><p>DRW_draw_pass(psl-&gt;custom_default_ps);</p></blockquote><blockquote><p>}</p></blockquote><p>就把那個pass拿去畫就好了，那結果就像這樣</p><p><a href="/assets/a01759e95c9/0*Rhm3uUUBN-Io1dOR.png" class="popup img-link shimmer"><img src="/assets/a01759e95c9/0*Rhm3uUUBN-Io1dOR.png" alt="" loading="lazy"></a></p><p>記得要把overlay關掉，因為那個會擋住線的顏色。</p><p>這邊我把fork下來的blender附在 <a href="https://github.com/maochinn/blender/tree/mao/source/blender/draw/engines/custom" target="_blank">這邊</a> ，可以自己研究，總結來說</p><p>如果只是要簡單的寫一個Render Engine原則上只要用Python就夠了，但是如果有效能需求之類的，需要從底層寫，那就要用C來撰寫，但幸好現在的版本已經把整個結構都開放出來，可以參考他們已經寫好的engine來參考，最後，如果也有人在研究相關的底層歡迎跟我討論，現在孤軍奮戰有點辛苦。</p><p>以上!</p><p>[1]bgl</p><p>blender GL，blender提供一系列類似於OpenGL的語法在python上</p><p><a href="https://wiki.blender.jp/Dev:2.8/Source/Viewport/DrawManager" target="_blank"><strong>Dev:2.8/Source/Viewport/DrawManager</strong></a> <a href="https://wiki.blender.jp/Dev:2.8/Source/Viewport/DrawManager" target="_blank"><em>Drawing 12,500 * 3 edges is not hard for the GPU. The main slowdown comes from iterating over all the state changes due…</em> wiki.blender.jp</a></p><p><a href="https://code.blender.org/2016/12/dependency-graph-proposal/" target="_blank" class="img-link shimmer" ><img src="https://code.blender.org/wp-content/uploads/2016/12/depsgraph_proposal.jpg" alt="" loading="lazy"></a></p><p><a href="https://zhuanlan.zhihu.com/p/94575502" target="_blank"><strong>改造blender 第四章：改造blender的roadmap</strong></a> <a href="https://zhuanlan.zhihu.com/p/94575502" target="_blank"><em>改造blender的roadmap首先出我们熟悉的图片生成出发…</em> zhuanlan.zhihu.com</a></p><p><em><a href="https://medium.com/maochinn/blender-2-82-render-engine-a01759e95c9" target="_blank">Post</a> converted from Medium by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/maochinn/">Maochinn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/blender/" class="post-tag no-text-decoration" >blender</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Blender%202.82%20Render%20Engine%20-%20Medium%20To%20Jekyll%20Starter&url=https%3A%2F%2Fmedium-to-jekyll-starter.zhgchg.li%2F%2Fposts%2Fa01759e95c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Blender%202.82%20Render%20Engine%20-%20Medium%20To%20Jekyll%20Starter&u=https%3A%2F%2Fmedium-to-jekyll-starter.zhgchg.li%2F%2Fposts%2Fa01759e95c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmedium-to-jekyll-starter.zhgchg.li%2F%2Fposts%2Fa01759e95c9%2F&text=Blender%202.82%20Render%20Engine%20-%20Medium%20To%20Jekyll%20Starter" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/83f3d470b656/">【自動化】學習筆記 — 01：硬體</a><li class="text-truncate lh-lg"> <a href="/posts/de28dc8582ec/">【自動化】學習筆記 — 00</a><li class="text-truncate lh-lg"> <a href="/posts/6560b300f03c/">【工作】NVIDIA GTC Taipai 2025 — Day 0：Building Digital Twins for Physical AI With NVIDIA Omniverse</a><li class="text-truncate lh-lg"> <a href="/posts/230d146467b3/">【工作】NVIDIA GTC Taipai 2025 — Day 1：Manufacturing sessions</a><li class="text-truncate lh-lg"> <a href="/posts/616f6e63db42/">【工作】NVIDIA GTC Taipai 2025 — Day 2：Physical Al and Robotics Sessions</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/computer-graphics/">computer-graphics</a> <a class="post-tag btn btn-outline-primary" href="/tags/omniverse/">omniverse</a> <a class="post-tag btn btn-outline-primary" href="/tags/digital-art/">digital-art</a> <a class="post-tag btn btn-outline-primary" href="/tags/nvidia/">nvidia</a> <a class="post-tag btn btn-outline-primary" href="/tags/blender/">blender</a> <a class="post-tag btn btn-outline-primary" href="/tags/krenz/">krenz</a> <a class="post-tag btn btn-outline-primary" href="/tags/business-trip/">business-trip</a> <a class="post-tag btn btn-outline-primary" href="/tags/siggraph/">siggraph</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%9B%BB%E8%85%A6%E5%9C%96%E5%AD%B8/">電腦圖學</a> <a class="post-tag btn btn-outline-primary" href="/tags/cosmos/">cosmos</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/9ab69f8ca0d1/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1659079408" data-df="ll" > Jul 29, 2022 </time><h4 class="pt-0 my-2">【Blender】Shading</h4><div class="text-muted"><p>稍微紀錄一下，如果想要做到一個面越正對著相機透明度越高可以這樣做。</p></div></div></a></article><article class="col"> <a href="/posts/8b414b22f7fb/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1721958896" data-df="ll" > Jul 26, 2024 </time><h4 class="pt-0 my-2">【Blender】客製化建立Texture</h4><div class="text-muted"><p>本篇簡單介紹如何透過Blender建立Texture並輸出，純粹只是解決一個很簡單的問題，怎麼快速的利用數值陣列去建立貼圖或者修改某個像素的值，事實上，要做到這件事情可以裝個Python和一些插件也做得到，但為什麼這麼要介紹利用Blender呢？因為Blender有還不錯的介面，…</p></div></div></a></article><article class="col"> <a href="/posts/20537e3c427d/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1721282892" data-df="ll" > Jul 18, 2024 </time><h4 class="pt-0 my-2">【Blender】客製化建立Shape Keys</h4><div class="text-muted"><p>本篇將介紹如何利用腳本在Blender中快速定義Shape，並且建立成不同的Shape Keys，簡單來說，Shape Keys能紀錄Mesh各種不同的形狀而不破壞最原始的佈線，具體來說，就是Mesh中同一個vertex可以有不同的position。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/74a8515473c0/" class="btn btn-outline-primary" aria-label="Older" ><p>Blender .blend format</p></a> <a href="/posts/d352576ec72a/" class="btn btn-outline-primary" aria-label="Newer" ><p>Paper: Distributed Ray Tracing</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/username">your_full_name</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.<br/> Automatically sync posts from Medium with <a href="https://zhgchg.li/posts/en-medium-to-jekyll/" target="_blank">ZhgChg.Li</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/computer-graphics/">computer-graphics</a> <a class="post-tag btn btn-outline-primary" href="/tags/omniverse/">omniverse</a> <a class="post-tag btn btn-outline-primary" href="/tags/digital-art/">digital-art</a> <a class="post-tag btn btn-outline-primary" href="/tags/nvidia/">nvidia</a> <a class="post-tag btn btn-outline-primary" href="/tags/blender/">blender</a> <a class="post-tag btn btn-outline-primary" href="/tags/krenz/">krenz</a> <a class="post-tag btn btn-outline-primary" href="/tags/business-trip/">business-trip</a> <a class="post-tag btn btn-outline-primary" href="/tags/siggraph/">siggraph</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%9B%BB%E8%85%A6%E5%9C%96%E5%AD%B8/">電腦圖學</a> <a class="post-tag btn btn-outline-primary" href="/tags/cosmos/">cosmos</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
