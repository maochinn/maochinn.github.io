---
title: "【筆記】Frame Buffer Object"
author: "帽捲"
date: 2021-03-30T08:25:34.841+0000
last_modified_at: 2021-05-16T09:05:53.221+0000
categories: ["Maochinn"]
tags: ["computer-graphics","opengl"]
description: "這邊是遇坑紀錄"
image:
  path: /assets/93752bbd3f7/1*yWeH44TlhXO7N8h7swz2Dg.png
render_with_liquid: false
---

### 【筆記】Frame Buffer Object

這邊是遇坑紀錄

強烈建議參考這篇

[**Framebuffers**](https://learnopengl.com/Advanced-OpenGL/Framebuffers){:target="_blank"} 
[_So far we've used several types of screen buffers: a color buffer for writing color values, a depth buffer to write and…_ learnopengl\.com](https://learnopengl.com/Advanced-OpenGL/Framebuffers){:target="_blank"}

FBO如果要bind複數的texture，可以這樣寫。


![](/assets/93752bbd3f7/1*yWeH44TlhXO7N8h7swz2Dg.png)


這邊可以注意到，我第二個texture想要拿來儲存深度值，所以只有一個channel。那對應的shader會長得像這樣


![](/assets/93752bbd3f7/1*aUv9fXcyIN7M2BAoVeDZDQ.png)


這邊坑就來了，我這樣做的時候把這個depth buffer拿出來的時候什麼都沒有\(全黑的\)，再找了一個下午的bug後，發現是一個blending造成的問題。


![](/assets/93752bbd3f7/1*AQp87d7e4LZ1snLTyobTOw.png)


\(以下推測\)因為我再render的時候有開啟blending，如上圖，而由於第二個texture沒有給定alpha值\(因為是float單通道\)，所以造成在blending時SRC\_ALPHA都是0的狀態，所以無論SRC給定甚麼值乘下去都是0。解決方法有三種。

第一個是，不要用blending，但很明顯這並不實際。

第二個是，我們可以強制把GL\_SRC\_ALPHA設成GL\_ONE，也就是把alpha值硬設成1，但是這麼做的缺點是我們其他的texture的alpha也會被硬設成1。

第三個是，我們直接把texture擴展成vec4，那這樣我們就可以給定alpha值為1，缺點就是會浪費空間。

那難道沒有更好的解法嗎，最後我選擇第三個，但是我仍然只給單通道的texture，但output的時候給vec4。


![](/assets/93752bbd3f7/1*vrU61mShHdi1pc11oXu4Sw.png)


\(以下猜測\)這時候你會想這樣不會造成記憶體超出嗎?至少我做的時候沒有錯，所以我猜應該是GL在操作的時候都會使用vec4，等所有都算完，在用一個mask把資料map到我們給定的texture，所以這邊的不一致不會造成錯誤。

事實上，如果要拿深度值也不用這樣拿，其實可以使用預設的depth component。這邊可以參考shadow

[**Shadow Mapping**](https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping){:target="_blank"} 
[_Shadows are a result of the absence of light due to occlusion\. When a light source's light rays do not hit an object…_ learnopengl\.com](https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping){:target="_blank"}


![](/assets/93752bbd3f7/1*1Z9QxcoUDTliqb5g3PI8uw.png)


但是要注意的是，這個depth不需要使用glDrawBuffers去登記，只要有attach這個depth texture就自動會幫你把這個texture填好。但這邊又一個小坑，depth texture跟depth render buffer是只能用其中一個的，所以如果你不小心在後面又做了depth rbo，這個depth texture會失效，GL只看最後一個depth attach。

所以這邊會有一個問題是到底要用rbo還是texture，理論上rbo會比較快，因為它不用當成texture，所以也不用做一些texture需要的操作\(例如sample\)，但好像也因此，rbo的東西是拿不出來的，使用者沒辦法read也沒辦法write，所有操作只有GL內部會做，所以如果需要read或write就只能弄成texture。

這邊囉嗦一點，depth component等同於gl\_FragCoord\.z的值，所以這邊要注意，這個值是0~1的depth值。詳細可以看

[**Depth testing**](https://learnopengl.com/Advanced-OpenGL/Depth-testing){:target="_blank"} 
[_In the coordinate systems chapter we've rendered a 3D container and made use of a depth buffer to prevent triangles…_ learnopengl\.com](https://learnopengl.com/Advanced-OpenGL/Depth-testing){:target="_blank"}

這邊可以注意到他為了要視覺化，所以她把depth轉換 **到** view space


![](/assets/93752bbd3f7/1*SsoDqr6v001lxgsFJd-RWA.png)


他首先把depth轉到NDC，也就是把值域從\[0, 1\] \-&gt;\[ \-1,1\]，然後乘了一堆亂七八糟，我這邊可以想成轉到view space，也就是\[ \-∞\.∞\]，但是為了視覺化，他又除了far，意思就是\[ \-far, far\]之間的值會是\[ \-1, 1\]，超過far的值會大於0又因為視覺化的值只用\[0, 1\]，所以結果就是\[0, far\] \-&gt;\[0, 1\]。

那我們可以對照一下blender是怎麼做的\(這邊我有稍微改寫一些\)


![](/assets/93752bbd3f7/1*c76DUA7uoZuXcGxTdamJgQ.png)


總之，他可以利用projection matrix的右下元素來判斷這是不是透視投影，接下來跟上面的算法類似，而事實上NDC\-&gt;view space這步其實就是乘上projection matrix的反矩陣，但因為我們只關心z元素，所以他們都直接把式子簡化成這樣，雖然兩者看起來有點不同，但其實你只要把兩個式子列出來你會發現基本上是一樣的，其實他們只差了一個負號。

事實上blender寫的才是對的，真正的轉換應該是\[0, 1\] \-&gt;\[ \-1, 1\] \-&gt;\[∞\. \-∞\]，因為gl的相機的朝向方向是\-z軸，所以我們能被render出來的東西他們在view space的z座標應該都是負的。

那為什麼learnOpenGL要多乘一個負號，因為他要視覺化畫，他要顯示的東西事實上應該是\[0, \-far\]，但是輸出的值域是\[0, 1\]，所以她再轉到view space的時候偷偷乘了一個負號。

這邊補充一個，如果我們用glClear會清掉attach到當前FBO的texture rbo，但是如果只想清掉其中一個texture可以透過重新設定glDrawBuffers來重新attach，這樣就可以只attach要被clear的texture。

[**Is it possible to clear just certain textures in a framebuffer with multi target rendering?**](https://stackoverflow.com/questions/18029258/is-it-possible-to-clear-just-certain-textures-in-a-framebuffer-with-multi-target){:target="_blank"} 
[_I have a framebuffer object in which I use Multi Target Rendering on N textures binded to it\. At a certain time, I want…_ stackoverflow\.com](https://stackoverflow.com/questions/18029258/is-it-possible-to-clear-just-certain-textures-in-a-framebuffer-with-multi-target){:target="_blank"}



_[Post](https://medium.com/maochinn/%E7%AD%86%E8%A8%98-frame-buffer-object-93752bbd3f7){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
